<?php


namespace Tests\commands;


use Base;
use EMedia\Oxygen\OxygenServiceProvider;
use Illuminate\Console\OutputStyle;
use Illuminate\Container\Container;
use Illuminate\Support\Facades\Artisan;
use Mockery as m;
use RepoCloner;

class OxygenSetupCommandTest extends \Orchestra\Testbench\TestCase
{
    protected $backupName = '_testbench_laravel_backup';
    protected $laravelPath;

    /**
     * @throws \Exception
     */
    protected function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        $this->laravelPath = dirname(__FILE__) . '/../../vendor/orchestra/testbench-core/laravel';
        $this->guardOrchestraInstalled();

        $this->backupFiles();
        $this->syncFiles();

//        $this->createRouteFiles();
    }

    protected function tearDown(): void
    {
//        $this->restoreFiles();
        parent::tearDown(); // TODO: Change the autogenerated stub
    }

    protected function createRouteFiles()
    {
        mkdir($this->laravelPath . '/routes');
        file_put_contents($this->laravelPath . '/routes/web.php' , '');
        file_put_contents($this->laravelPath . '/routes/api.php' , '');
    }

    protected function syncFiles()
    {
//        $base = new Base([
//            "routes/web.php"
//        ]);
//
//        $cloner = new RepoCopy($this->laravelPath);
//        $cloner->clone($base);
    }

    protected function backupFiles()
    {
        `cp -r $this->laravelPath $this->backupName`;
    }

    protected function restoreFiles()
    {
        `rm -rf $this->laravelPath`;
        `cp -r $this->backupName $this->laravelPath`;
        `rm -rf ./$this->backupName`;
    }

    protected function getPackageProviders($app)
    {
        return [
            OxygenServiceProvider::class
        ];
    }

    /**
     * @test
     * @throws \Exception
     */
    public function test_OxygenSetupCommand_handle_sets_up_project()
    {

            $this->assertTrue(true);
//
//        $moved = false;
//        Artisan::command('setup:move-public {--y}', function () use ($moved) {
//            $moved = true;
//        });
//
//        $this->artisan('setup:oxygen-project')
//             ->expectsQuestion('What is the project name?', 'Test')
//            ->expectsQuestion('What is the `from` email address for system emails? (Press ENTER key for default)', 'test@example.com')
//            ->expectsQuestion('What is your email to seed the database? (Press ENTER key for default)', 'test@example.com')
//            ->expectsQuestion('What is the local development URL? (Press ENTER key for default)', 'foo')
//            ->expectsQuestion('create_role_permission_tables.php file already exists. Create another?', 'No')
//             ->assertExitCode(0);
//
//        $this->assertTrue($moved);

    }

    /**
     * @throws \Exception
     */
    protected function guardOrchestraInstalled()
    {
        $missing = !file_exists($this->laravelPath);
        if ($missing) {
            throw new \Exception("Missing directory {$this->laravelPath}, is orchestra/testbench installed?");
        }
    }


}